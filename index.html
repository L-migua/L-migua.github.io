<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿‘æœˆå¤¢çºªæŠ½å¡æ¨¡æ‹Ÿå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fbc2eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .draw-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            font-weight: bold;
        }
        
        .btn-single {
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            color: #333;
        }
        
        .btn-multi {
            background: linear-gradient(45deg, #a18cd1, #fbc2eb);
            color: #fff;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            /* width: 270px;
            height: 450px; */
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background-size: cover;
            background-position: center;
        }
        
        @keyframes flipAnimation {
            0% {
                transform: rotateY(180deg); /* ä»èƒŒé¢å¼€å§‹ */
            }
            10%{
                transform: rotateY(250deg);
            }
            100% {
                transform: rotateY(360deg); /* å®Œæˆä¸¤å‘¨ç¿»è½¬ï¼Œåœåœ¨æ­£é¢ */
            }
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            margin: 0 auto 40px;
            perspective:1000px;
            transform: rotateY(180deg);
            
        }
        
        /* åŸºç¡€é“¾æ¥æ ·å¼ */
        .basic-link {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .basic-link:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex
        ;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            padding: 20px;
            box-sizing: border-box;

            background-repeat: no-repeat;
    background-size: cover;
        }
        
        .card-back {
            background: linear-gradient(45deg, #3a3a6d, #2a2a4a);
            display: flex;
            justify-content: center;
            align-items: center;
            transform: rotateY(180deg);
        }
        
        .card-back-content {
            text-align: center;
            padding: 20px;
        }
        
        .card-logo {
            font-size: 3rem;
            margin-bottom: 20px;
            color: gold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .card-back-text {
            font-size: 1.5rem;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .card-name-container {
            position: absolute;
            bottom: 20px;
            left: 15px;
            right: 15px;
            background: rgba(60, 60, 80, 0.7);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        .card-name {
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .card-rarity {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            color: gold;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
        }
        
        /* å…¨å±å¡ç‰‡å±•ç¤º */
        .card-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .card-fullscreen.active {
            display: flex;
        }
        
        .fullscreen-card {
            width: 46.8vh;
            height: 75vh;
            margin-bottom: 30px;
        }
        
        .skip-btn {
            padding: 15px 40px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .skip-btn:hover {
            background: rgba(255, 50, 50, 0.9);
            transform: translateY(-3px);
        }
        
        /* åè¿ç»“æœå±•ç¤º */
        .multi-result {
            display: none;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            max-width: 900px;
        }
        
        .multi-result.active {
            display: flex;
        }
        
        .multi-card {
            width: 160px;
            height: 266px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .multi-card:hover {
            transform: scale(1.05);
        }
        
        .multi-card .card-name-container {
            bottom: 10px;
            left: 10px;
            right: 10px;
            padding: 8px 12px;
        }
        
        .multi-card .card-name {
            font-size: 1rem;
        }
        
        .history {
            margin-top: 40px;
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .history h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #fbc2eb;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .five-star {
            animation: glow 2s infinite alternate;
            border: 2px solid gold;
            background-color: gold;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 10px gold;
            }
            to {
                box-shadow: 0 0 25px gold, 0 0 35px rgba(255, 215, 0, 0.5);
            }
        }
        .out-anime{
            animation: out-anime 1s forwards;
            animation-timing-function: ease-out;
        }

        @keyframes out-anime {
            0% {
                transform: rotateY(360deg); /* ä»èƒŒé¢å¼€å§‹ */
            }
            70%{
                transform: rotateY(210deg);
            }
            100% {
                transform: rotateY(180deg); /* å®Œæˆä¸¤å‘¨ç¿»è½¬ï¼Œåœåœ¨æ­£é¢ */
            }
        }
        
        .card-enter {
            opacity: 0;
            transform: scale(0.8) rotate(-10deg);
        }
        
        .card-active {
            opacity: 1;
            transform: scale(1) rotate(0);
        }
        
        .flip {
            animation: flipAnimation 2s forwards;
            animation-timing-function: ease-out;
        }
        
        footer {
            margin-top: 40px;
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .draw-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .fullscreen-card {
                width: 300px;
                height: 500px;
            }
            
            .multi-card {
                width: 140px;
                height: 233px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ¿‘æœˆå¤¢çºªæŠ½å¡æ¨¡æ‹Ÿå™¨</h1>
            <a href="https://space.bilibili.com/3026704" class="basic-link">æœ‰ç‚¹æƒ³æ‰“æ¿‘æœˆå¤¢çºªäº†</a>
        </header>
        
        <div class="draw-buttons">
            <button class="btn btn-single" id="singleDraw">å•æŠ½</button>
            <button class="btn btn-multi" id="multiDraw">åè¿æŠ½</button>
        </div>
        
        <div class="card-fullscreen" id="cardFullscreen">
            <div class="card fullscreen-card" id="fullscreenCard">
                <div class="card-inner" id="cardInner">
                    <div class="card-front">
                        <!-- æ­£é¢å†…å®¹å°†ç”±JSåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <div class="card-back">
                        <div class="card-back-content">
                            <div class="card-logo">ğŸ´</div>
                            <div class="card-back-text">æ¿‘æœˆå¤¢çºªè¯­éŸ³æŠ½å¡</div>
                            <div>å›¾ç‰‡åŠ è½½è¿›åº¦ï¼š<span id="imgProgress"></span></div>
                            <div>éŸ³é¢‘åŠ è½½è¿›åº¦ï¼š<span id="audioProgress"></span></div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div style="display: flex;justify-content: center;flex-direction: column;">
                <button class="skip-btn" id="skipMultiBtn" style="display: none;">è·³è¿‡å…¨éƒ¨</button>
                <button class="skip-btn" id="nextCard">ä¸‹ä¸€å¼ </button>
            </div>
        </div>
        
        <div class="multi-result" id="multiResult">
            <!-- åè¿ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        
        <div class="history">
            <h2>æŠ½å¡è®°å½•</h2>
            <div class="history-list" id="historyList">
                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        <div class="probability-chart">
    <h2>æŠ½å¡æ¦‚ç‡åˆ†å¸ƒ</h2>
    <div class="chart-container">
        <div class="chart-bar">
            <div class="bar-fill five-star" style="width: 2%">
                <span class="percentage">2%</span>
                <span class="rarity">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
        </div>
        <div class="chart-bar">
            <div class="bar-fill four-star" style="width: 18%">
                <span class="percentage">18%</span>
                <span class="rarity">â˜…â˜…â˜…â˜…</span>
            </div>
        </div>
        <div class="chart-bar">
            <div class="bar-fill three-star" style="width: 80%">
                <span class="percentage">80%</span>
                <span class="rarity">â˜…â˜…â˜…</span>
            </div>
        </div>
    </div>
    <div class="chart-legend">
        <div class="legend-item">
            <span class="color-box five-star"></span>
            <span>äº”æ˜Ÿå¡ (2%) - <span id="5st"></span>å¼ </span>
        </div>
        <div style="padding-left:25px;" id="5stList"></div>
        <div class="legend-item">
            <span class="color-box four-star"></span>
            <span>å››æ˜Ÿå¡ (18%) - <span id="4st"></span>å¼ </span>
            
        </div>
        <div style="padding-left:25px;" id="4stList"></div>
        <div class="legend-item">
            <span class="color-box three-star"></span>
            <span>ä¸‰æ˜Ÿå¡ (80%) - <span id="3st"></span>å¼ </span>
        </div>
        <div style="padding-left:25px;" id="3stList"></div>
    </div>
</div>

<style>
.probability-chart {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    width: 100%;
    max-width: 600px;
}

.probability-chart h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #fbc2eb;
}

.chart-container {
    margin-bottom: 20px;
}

.chart-bar {
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    margin-bottom: 10px;
    overflow: hidden;
    position: relative;
}

.bar-fill {
    height: 100%;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    transition: width 1s ease-in-out;
}

.five-star {
}

.four-star {
    background: linear-gradient(90deg, rgba(192, 192, 255, 0.7), rgba(192, 192, 255, 0.9));
}

.three-star {
    background: linear-gradient(90deg, rgba(176, 224, 230, 0.7), rgba(176, 224, 230, 0.9));
}

.percentage, .rarity {
    color: #1a1a2e;
    font-weight: bold;
    text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
}

.chart-legend {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

@media (max-width: 768px) {
    .probability-chart {
        padding: 15px;
    }
    
    .chart-bar {
        height: 35px;
    }
    
    .bar-fill {
        padding: 0 10px;
        font-size: 0.9rem;
    }
}
</style>
        <footer>
            <p>æœ¬é¡µé¢ä»…ä¸ºæ¨¡æ‹ŸæŠ½å¡ä½“éªŒï¼Œä¸æ¶‰åŠçœŸå®è´§å¸äº¤æ˜“</p>
        </footer>
    </div>

    <script>
        // å¡æ± æ•°æ®
        const cardPool = {
  "5": {
    "rate": 0.02,
    "cards": [
      {
        "name": "ç”œèœœå›åº”",
        "image": [
        "./png/00055-1920844438.png.webp"
        ],
        "audio": "./mp3/æˆ‘ä¹Ÿå–œæ¬¢ä½ å‘€å®å®.wav.mp3"
      },
      {
        "name": "æ¸©æŸ”ç­”åº”",
        "image": [
            "./png/00049-3448258678.png.webp"
        ],
        "audio": "./mp3/å¥½çš„å®å®.wav.mp3"
      },
      {
        "name": "æ·±æƒ…å‘Šç™½",
        "image": [
            "./png/00060-1384665409.png.webp"
        ],
        "audio": "./mp3/æˆ‘å¥½å–œæ¬¢ä½ æˆ‘å–œæ¬¢ä½ å¥½ä¹…äº†ä½ çŸ¥é“ä¸.wav.mp3"
      }
    ]
  },
  "4": {
    "rate": 0.18,
    "cards": [
      {
        "name": "åˆæ¬¡è§é¢",
        "image": [
            "./png/00043-3535785748.png.webp"
        ],
        "audio": "./mp3/æˆ‘ä»¬æ‰ç¬¬ä¸€å¤©è§é¢.wav.mp3"
      },
      {
        "name": "å¹»æƒ³æ—¶åˆ»",
        "image": [
            "./png/00065-3504180296.png.webp"
        ],
        "audio": "./mp3/ç°åœ¨æ˜¯å¹»æƒ³æ—¶åˆ».wav.mp3"
      },
      {
        "name": "å°ç”·å‹çƒ¦æ¼",
        "image": [
            "./png/00046-4039055635.png.webp"
        ],
        "audio": "./mp3/å•Šå°ç”·å‹åƒé†‹ç”Ÿæ°”æ€ä¹ˆåŠé‚£å“.wav.mp3"
      }
    ]
  },
  "3": {
    "rate": 0.8,
    "cards": [
      {
        "name": "å¥½äººå¡",
        "image": [
            "./png/00039-666148861.png.webp"
        ],
        "audio": "./mp3/ä»€ä¹ˆæ„æ€å•Šä½ æ˜¯ä¸ªå¥½äºº.wav.mp3"
      },
      {
        "name": "æœ‹å‹ç•Œé™",
        "image": [
            "./png/00016-1497929218.png.webp"
        ],
        "audio": "./mp3/æˆ‘åªæŠŠä½ å½“æœ‹å‹æˆ‘è¯´ä½ æ˜¯ä¸ªå¥½äºº.wav.mp3"
      },
      {
        "name": "æ˜å¹´å†è¯´",
        "image": [
            "./png/00015-2509351029.png.webp"
        ],
        "audio": "./mp3/æ˜å¹´æ˜å¹´å†è¯´.wav.mp3"
      },
      {
        "name": "èº«ä»½è´¨ç–‘",
        "image": [
            "./png/00015-2174457448.png.webp"
        ],
        "audio": "./mp3/ä½ æ˜¯è°.wav.mp3"
      },
      {
        "name": "åŒæ¶è¡¨è¾¾",
        "image": [
            "./png/00014-4086014375.png.webp"
        ],
        "audio": "./mp3/å»æ­»å§ä½ .wav.mp3"
      },
      {
        "name": "é„™è§†",
        "image": [
            "./png/00013-3771896979.png.webp"
        ],
        "audio": "./mp3/ä½ ä¹Ÿé….wav.mp3"
      },
      {
        "name": "å®…å®…æ‰¹åˆ¤",
        "image": [
            "./png/00013-1113505741.png.webp"
        ],
        "audio": "./mp3/å°±æ˜¯è¿™æ ·æ¶å¿ƒç§å®…çœŸæ¶å¿ƒ.wav.mp3"
      },
      {
        "name": "äºŒæ¬¡å…ƒåŒæ¶",
        "image": [
            "./png/00012-2935115470.png.webp"
        ],
        "audio": "./mp3/äºŒæ¬¡å…ƒçœŸæ¶å¿ƒå–µ.wav.mp3"
      },
      {
        "name": "ç²—æš´é©±é€",
        "image": [
            "./png/00011-187898591.png.webp"
        ],
        "audio": "./mp3/å¬æ˜ç™½å°±æ»šè¿œç‚¹.wav.mp3"
      }
    ]
  }
}

        // å…¨å±€å˜é‡
        let isDrawing = false;
        let multiDrawResults = [];
        let currentMultiIndex = 0;
        let audioContext = null;
        let isMultiDraw = false;

        // DOMå…ƒç´ 
        const singleDrawBtn = document.getElementById('singleDraw');
        const multiDrawBtn = document.getElementById('multiDraw');
        const cardFullscreen = document.getElementById('cardFullscreen');
        const fullscreenCard = document.getElementById('fullscreenCard');
        const cardInner = document.getElementById('cardInner');
        const nextCardBtn = document.getElementById('nextCard');
        const skipMultiBtn = document.getElementById('skipMultiBtn');
        const multiResult = document.getElementById('multiResult');
        const historyList = document.getElementById('historyList');
        const imgProgress = document.getElementById('imgProgress');
        const audioProgress = document.getElementById('audioProgress');
        // åˆå§‹åŒ–
        function init() {
            singleDrawBtn.addEventListener('click', () => drawCard('single'));
            multiDrawBtn.addEventListener('click', () => drawCard('multi'));
            nextCardBtn.addEventListener('click', showNextMultiCard);
            skipMultiBtn.addEventListener('click', skipMultiDraw);
            
            // åˆå§‹åŒ–Web Audio API
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error('Web Audio API is not supported in this browser');
            }

            initRateTable()
        }

        function initRateTable(){
            document.getElementById("5st").innerText = cardPool["5"]["cards"].length
            document.getElementById("4st").innerText = cardPool["4"]["cards"].length
            document.getElementById("3st").innerText = cardPool["3"]["cards"].length

            document.getElementById("5stList").innerHTML = cardPool["5"]["cards"].map(card => `<span style="padding-right:10px;">${card.name}</span>`).join("")
            document.getElementById("4stList").innerHTML = cardPool["4"]["cards"].map(card => `<span style="padding-right:10px;">${card.name}</span>`).join("")
            document.getElementById("3stList").innerHTML = cardPool["3"]["cards"].map(card => `<span style="padding-right:10px;">${card.name}</span>`).join("")
        }

        // æŠ½å¡å‡½æ•°
        function drawCard(type) {
            if (isDrawing) return;
            
            isDrawing = true;
            isMultiDraw = type === 'multi';
            multiDrawResults = [];
            currentMultiIndex = 0;
            if (type === 'single') {
                const card = getRandomCard();
                
                showCardFullscreen(card, type);
                addToHistory(card);
            } else {
                
                
                for (let i = 0; i < 10; i++) {
                    const card = getRandomCard();
                    multiDrawResults.push(card);
                    addToHistory(card);
                }
                
                // æ˜¾ç¤ºè·³è¿‡æŒ‰é’®
                skipMultiBtn.style.display = 'block';
                showMultiDraw();
            }
        }

        // è·å–éšæœºå¡ç‰‡
        function getRandomCard() {
            const rand = Math.random();
            let rarity;
            
            if (rand < cardPool['5'].rate) {
                rarity = '5';
            } else if (rand < cardPool['5'].rate + cardPool['4'].rate) {
                rarity = '4';
            } else {
                rarity = '3';
            }
            
            const cards = cardPool[rarity].cards;
            const cardIndex = Math.floor(Math.random() * cards.length);
            
            return {
                name: cards[cardIndex].name,
                image: cards[cardIndex].image,
                audio: cards[cardIndex].audio,
                rarity: rarity
            };
        }

        function loadProgress(url,progressCallback){
            return fetch(url)
                .then((response)=>{
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const contentLength = response.headers.get('content-length');
                    const total = parseInt(contentLength, 10);
                    let loaded = 0;
                    // ä½¿ç”¨ ReadableStream ç›‘æ§è¿›åº¦
                    const reader = response.body.getReader();
                    const chunks = [];

                    return function whileRead(){
                        return reader.read()
                            .then(({done, value})=>{
                                if (done) {
                                    return
                                } ;
                                loaded += value.length;
                        
                                if (progressCallback) {
                                    const percent = Math.round((loaded / total) * 100);
                                    progressCallback(percent, loaded, total);
                                }
                                return whileRead()
                            })
                    }()
                })
        }

        // å…¨å±æ˜¾ç¤ºå¡ç‰‡
        function showCardFullscreen(card, type) {
            // é‡ç½®å¡ç‰‡ä¸ºèƒŒé¢
            cardInner.classList.remove('flip');
            
            // è®¾ç½®å¡ç‰‡æ­£é¢æ ·å¼
            const cardFront = fullscreenCard.querySelector('.card-front');
            cardFront.style.backgroundImage = card.image.map(url => `url('${url}')`).join(',');
            fullscreenCard.className = `card fullscreen-card ${card.rarity === '5' ? 'five-star' : ''}`;
            
            // æ·»åŠ å¡ç‰‡ä¿¡æ¯
            let cardInfo = cardFront.querySelector('.card-name-container');
            if (!cardInfo) {
                cardInfo = document.createElement('div');
                cardInfo.className = 'card-name-container';
                cardInfo.innerHTML = `
                    <div class="card-name">${card.name}</div>
                    <div class="card-rarity">${getStars(card.rarity)}</div>
                `;
                cardFront.appendChild(cardInfo);
            } else {
                cardInfo.innerHTML = `
                    <div class="card-name">${card.name}</div>
                    <div class="card-rarity">${getStars(card.rarity)}</div>
                `;
            }
            
            // æ˜¾ç¤ºå…¨å±å®¹å™¨
            cardFullscreen.classList.add('active');
            Promise.all([loadProgress(card.image[0], (percent, loaded, total)=>{imgProgress.innerText = `${percent}%`}),loadProgress(card.audio,(percent, loaded, total)=>{audioProgress.innerText = `${percent}%`})])
                // .then((responseList)=>{
                //     return Promise.all([responseList[0].blob(),responseList[1].blob()])
                // })
                .then(()=> {
                    // æ’­æ”¾ç¿»è½¬åŠ¨ç”»
                    cardInner.classList.add('flip');
                    // åœ¨ç¿»è½¬å®Œæˆåæ’­æ”¾éŸ³æ•ˆ
                    playAudio(card.audio);
                })
                .catch((e)=>{
                    alert("å§æ§½ å›¾ç‰‡æˆ–éŸ³é¢‘åŠ è½½å¤±è´¥äº†\n" + e)

                    // æ’­æ”¾ç¿»è½¬åŠ¨ç”»
                    cardInner.classList.add('flip');
                    // åœ¨ç¿»è½¬å®Œæˆåæ’­æ”¾éŸ³æ•ˆ
                    playAudio(card.audio);
                })
            
            
            
            // å¦‚æœæ˜¯å•æŠ½ï¼Œä¿®æ”¹æŒ‰é’®æ–‡å­—
            if (type === 'single') {
                nextCardBtn.textContent = 'å…³é—­';
                skipMultiBtn.style.display = 'none';
            } else {
                nextCardBtn.textContent = currentMultiIndex < multiDrawResults.length - 1 ? 'ä¸‹ä¸€å¼ ' : 'å®Œæˆ';
                skipMultiBtn.style.display = 'block';
            }
        }

        // æ˜¾ç¤ºåè¿æŠ½
        function showMultiDraw() {
            if (currentMultiIndex >= multiDrawResults.length) {
                finishMultiDraw();
                return;
            }
            
            const card = multiDrawResults[currentMultiIndex];
            
            showCardFullscreen(card, 'multi');
        }

        // æ˜¾ç¤ºä¸‹ä¸€å¼ åè¿å¡ç‰‡
        function showNextMultiCard() {
            if (currentMultiIndex >= multiDrawResults.length - 1) {
                finishMultiDraw();
                return;
            }
            cardInner.classList.add("out-anime")
            cardInner.classList.remove('flip');
            setTimeout(function(){
                cardInner.classList.remove("out-anime")
                currentMultiIndex++;
                showMultiDraw();    
            }, 1000)
        }

        // è·³è¿‡åè¿æŠ½åŠ¨ç”»
        function skipMultiDraw() {
            finishMultiDraw();
        }

        // å®Œæˆåè¿æŠ½
        function finishMultiDraw() {
            // éšè—å…¨å±æ˜¾ç¤º
            cardFullscreen.classList.remove('active');
            
            // éšè—è·³è¿‡æŒ‰é’®
            skipMultiBtn.style.display = 'none';
            
            // æ˜¾ç¤ºæ‰€æœ‰å¡ç‰‡
            multiResult.classList.add('active');
            multiResult.innerHTML = '';
            
            multiDrawResults.sort((a,b) => b.rarity - a.rarity).forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = `multi-card ${card.rarity === '5' ? 'five-star' : ''}`;
                cardElement.style.backgroundImage = card.image.map(url => `url('${url}')`).join(',');
                
                const cardInfo = document.createElement('div');
                cardInfo.className = 'card-name-container';
                cardInfo.innerHTML = `
                    <div class="card-name">${card.name}</div>
                    <div class="card-rarity">${getStars(card.rarity)}</div>
                `;
                
                cardElement.appendChild(cardInfo);
                
                // æ·»åŠ ç‚¹å‡»æ’­æ”¾éŸ³é¢‘åŠŸèƒ½
                cardElement.addEventListener('click', () => {
                    playAudio(card.audio);
                });
                
                multiResult.appendChild(cardElement);
            });
            
            isDrawing = false;
        }

        // è·å–æ˜Ÿæ˜ŸHTML
        function getStars(rarity) {
            let stars = '';
            for (let i = 0; i < parseInt(rarity); i++) {
                stars += '<span class="star">â˜…</span>';
            }
            return stars;
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(card) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const date = new Date();
            const timeString = date.toLocaleTimeString();
            
            historyItem.innerHTML = `
                <span>${card.name}</span>
                <span>${getStars(card.rarity)}</span>
                <span>${timeString}</span>
            `;
            
            historyList.prepend(historyItem);
        }

        // æ’­æ”¾éŸ³é¢‘
        function playAudio(url) {
            if (!audioContext) return;
            
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);
                    source.start();
                })
                .catch(e => console.error('Error with decoding audio data', e));
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', init);
    </script>
</body>
</html>